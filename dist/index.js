!function(e,o){for(var r in o)e[r]=o[r]}(this,function(e){var o={};function r(n){if(o[n])return o[n].exports;var t=o[n]={i:n,l:!1,exports:{}};return e[n].call(t.exports,t,t.exports,r),t.l=!0,t.exports}return r.m=e,r.c=o,r.d=function(e,o,n){r.o(e,o)||Object.defineProperty(e,o,{configurable:!1,enumerable:!0,get:n})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(o,"a",o),o},r.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},r.p="",r.w={},r(r.s=3)}([function(e,o){e.exports=require("firebase-admin")},function(e,o){e.exports=require("firebase-functions")},function(e,o,r){"use strict";var n=this&&this.__awaiter||function(e,o,r,n){return new(r||(r=Promise))(function(t,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function l(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){e.done?t(e.value):new r(function(o){o(e.value)}).then(s,l)}a((n=n.apply(e,o||[])).next())})};Object.defineProperty(o,"__esModule",{value:!0});const t=r(1),i=r(0);o.mirrorSubscriptionsFollowed=t.database.ref("/following/{follower_id}/{followed_id}").onCreate((e,o)=>n(this,void 0,void 0,function*(){const r=e.val(),n=o.params.follower_id,t=o.params.followed_id;console.log(`[FOLLOWED] Mirroring Subscriptions: User[${n}] FOLLOWED User[${t}], DATA: `,r);const s={};s.date=r.date;try{const e={notification:{title:"New Follower",body:`You were followed by ${(yield i.database().ref("users/"+n).once("value")).val().username}!`}},o=yield i.database().ref(`users/${t}/fcm_tokens`).once("value");if(null!==o.val()){const r=Object.keys(o.val()),n=[],t=[];(yield i.messaging().sendToDevice(r,e)).results.forEach((e,i)=>{const s=e.error;s?(console.warn("Failure sending notification to ",r[i],s),"messaging/invalid-registration-token"!==s.code&&"messaging/registration-token-not-registered"!==s.code||n.push(o.ref.child(r[i]).remove())):t.push(r[i])}),console.log(`Notification was sent to ${t.length} tokens : `,t)}else console.warn(`User[${t}] does not have any FCM tokens!`);return i.database().ref(`/followers/${t}/${n}`).set(s)}catch(e){console.error("ERROR CAUGHT: ",e)}})),o.mirrorSubscriptionsUnfollowed=t.database.ref("/following/{follower_id}/{followed_id}").onDelete((e,o)=>{const r=o.params.follower_id,n=o.params.followed_id,t=e.val();return console.log(`[UNFOLLOWED] Mirroring Subscriptions. User[ ${o.params.user_id} UNFOLLOWED User[${n}], DATA: `,t),i.database().ref(`/followers/${n}/${r}`).remove()})},function(e,o,r){"use strict";Object.defineProperty(o,"__esModule",{value:!0});const n=r(1);r(0).initializeApp(n.config().firebase);const t=r(2);o.mirrorSubscriptionsFollowed=t.mirrorSubscriptionsFollowed,o.mirrorSubscriptionsUnfollowed=t.mirrorSubscriptionsUnfollowed}]));